<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbot - Enhanced</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --dark-bg: #0f0f23;
            --dark-surface: #1a1a2e;
            --dark-elevated: #16213e;
            --text-primary: #ffffff;
            --text-secondary: #b8c5d6;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            --glow: 0 0 30px rgba(102, 126, 234, 0.3);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
            z-index: -1;
            animation: backgroundShift 20s ease-in-out infinite alternate;
        }

        @keyframes backgroundShift {
            0% { transform: scale(1) rotate(0deg); }
            100% { transform: scale(1.1) rotate(2deg); }
        }

        .chat-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: rgba(26, 26, 46, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .title {
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--primary-gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: titleGlow 3s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            0% { filter: drop-shadow(0 0 5px rgba(102, 126, 234, 0.5)); }
            100% { filter: drop-shadow(0 0 20px rgba(102, 126, 234, 0.8)); }
        }

        .actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .actions button {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            background: var(--accent-gradient);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
        }

        .actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 172, 254, 0.4);
        }

        .incognito-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px 15px;
            border-radius: 25px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .incognito-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .incognito-toggle input {
            appearance: none;
            width: 50px;
            height: 25px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .incognito-toggle input:checked {
            background: var(--accent-gradient);
        }

        .incognito-toggle input::before {
            content: '';
            position: absolute;
            width: 21px;
            height: 21px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .incognito-toggle input:checked::before {
            transform: translateX(25px);
        }

        .tab-bar {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            background: rgba(26, 26, 46, 0.6);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 8px;
            border: 1px solid var(--border-color);
        }

        .tab {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            transition: left 0.3s ease;
            z-index: -1;
        }

        .tab.active {
            color: white;
            background: var(--primary-gradient);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .tab:hover:not(.active) {
            color: white;
            background: rgba(102, 126, 234, 0.2);
        }

        .chat-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(26, 26, 46, 0.4);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .chat-log {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            max-height: 60vh;
            scroll-behavior: smooth;
        }

        .chat-log::-webkit-scrollbar {
            width: 8px;
        }

        .chat-log::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-log::-webkit-scrollbar-thumb {
            background: var(--primary-gradient);
            border-radius: 4px;
        }

        .message-container {
            margin-bottom: 20px;
            display: flex;
            animation: messageSlide 0.4s ease-out;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-container.user {
            justify-content: flex-end;
        }

        .message-container.bot {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 80%;
            padding: 18px 24px;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
        }

        .user-message {
            background: var(--primary-gradient);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 8px;
        }

        .bot-message {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            border-bottom-left-radius: 8px;
            border-left: 3px solid var(--accent-gradient);
        }

        .message-text {
            line-height: 1.6;
            font-size: 1rem;
        }

        .copy-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }

        .message-bubble:hover .copy-icon {
            opacity: 1;
        }

        .copy-icon:hover {
            background: var(--accent-gradient);
            transform: scale(1.1);
        }

        .input-container {
            padding: 30px;
            background: rgba(22, 33, 62, 0.6);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        #inputField {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 15px 20px;
            color: var(--text-primary);
            font-size: 1rem;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        #inputField:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.6);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
        }

        #inputField::placeholder {
            color: var(--text-secondary);
        }

        .send-btn {
            padding: 15px 25px;
            background: var(--primary-gradient);
            border: none;
            border-radius: 15px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .search-container {
            padding: 20px 30px;
            background: rgba(22, 33, 62, 0.4);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 15px;
        }

        #searchInput {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px 18px;
            color: var(--text-primary);
            backdrop-filter: blur(10px);
        }

        #searchInput:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.6);
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.2);
        }

        .search-btn {
            padding: 12px 20px;
            background: var(--accent-gradient);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .upload-container {
            padding: 30px;
            background: rgba(22, 33, 62, 0.6);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .upload-container label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        #fileUpload {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 15px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #fileUpload:hover {
            border-color: rgba(102, 126, 234, 0.6);
            background: rgba(102, 126, 234, 0.1);
        }

        .upload-btn {
            padding: 15px 25px;
            background: var(--secondary-gradient);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(240, 147, 251, 0.3);
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(240, 147, 251, 0.4);
        }

        .ask-doc-container {
            padding: 30px;
            background: rgba(22, 33, 62, 0.4);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 15px;
        }

        #docQuestionInput {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px 20px;
            color: var(--text-primary);
            backdrop-filter: blur(10px);
        }

        #docQuestionInput:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.6);
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.2);
        }

        .ask-btn {
            padding: 15px 25px;
            background: var(--accent-gradient);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(79, 172, 254, 0.3);
        }

        .ask-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(79, 172, 254, 0.4);
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
            font-style: italic;
            padding: 10px 0;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: var(--accent-gradient);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out both;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingBounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .chat-container {
                padding: 10px;
            }

            .top-bar {
                flex-direction: column;
                gap: 15px;
                padding: 20px;
            }

            .title {
                font-size: 1.5rem;
            }

            .actions {
                justify-content: center;
                flex-wrap: wrap;
            }

            .tab-bar {
                flex-direction: column;
                gap: 5px;
            }

            .message-bubble {
                max-width: 95%;
            }

            .input-container,
            .search-container,
            .upload-container,
            .ask-doc-container {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* Load more button */
        .load-more-btn {
            display: block;
            margin: 20px auto;
            padding: 12px 25px;
            background: var(--primary-gradient);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .load-more-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="actions">
                <label class="incognito-toggle">
                    <input type="checkbox" id="incognitoToggle" onchange="toggleIncognito()">
                    <span>Incognito Mode</span>
                </label>
            </div>
            <div class="title">
                <i class="fas fa-robot"></i> AI Chatbot
            </div>
            <div class="actions">
                <button onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                <button onclick="clearChat()">
                    <i class="fas fa-trash"></i> Clear Chat
                </button>
            </div>
        </div>

        <!-- Tab Bar -->
        <div class="tab-bar">
            <button id="groqTab" class="tab active" onclick="showGroqChat()">
                <i class="fas fa-comments"></i> Groq Chat
            </button>
            <button id="ragTab" class="tab" onclick="showRagChat()">
                <i class="fas fa-file-alt"></i> Document Q&A (RAG)
            </button>
            <button id="amritaTab" class="tab" onclick="showAmritaChat()">
                <i class="fas fa-university"></i> Amrita University Q&A
            </button>
        </div>

        <!-- Groq Chat Screen -->
        <div id="groqScreen" class="chat-screen">
            <div id="chatLog" class="chat-log">
                <button id="loadMoreButton" class="load-more-btn" onclick="loadMoreChatHistory()" style="display:none;">
                    <i class="fas fa-chevron-up"></i> Load More Messages
                </button>
            </div>
            <div class="input-container">
                <textarea id="inputField" placeholder="Type your message here..." onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>
                <button class="send-btn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
                <button id="groqMicBtn" class="send-btn" type="button" onclick="startTeluguRecording('inputField')">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Search chat history...">
                <button class="search-btn" onclick="searchChat()">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
        </div>

        <!-- RAG Chat Screen -->
        <div id="ragScreen" class="chat-screen" style="display:none;">
            <div id="ragChatLog" class="chat-log"></div>
            <div class="upload-container">
                <label for="fileUpload"><i class="fas fa-upload"></i> Upload a file:</label>
                <input type="file" id="fileUpload">
                <button id="uploadBtn" class="upload-btn" onclick="uploadFile()">
                    <i class="fas fa-cloud-upload-alt"></i> Upload
                </button>
            </div>
            <div class="ask-doc-container">
                <input type="text" id="docQuestionInput" placeholder="Ask a question about your uploaded document...">
                <button id="askBtn" class="ask-btn" onclick="askDocumentQuestion()">
                    <i class="fas fa-question-circle"></i> Ask
                </button>
                <button id="ragMicBtn" class="ask-btn" type="button" onclick="startTeluguRecording('docQuestionInput')">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
        </div>

        <!-- Amrita University Q&A Screen -->
        <div id="amritaScreen" class="chat-screen" style="display:none;">
            <div id="amritaChatLog" class="chat-log"></div>
            <div class="input-container">
                <input type="text" id="amritaQuestionInput" placeholder="Ask about Amrita University...">
                <button class="send-btn" onclick="askAmritaQuestion()">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            document.body.classList.add('light-mode');
            // Note: localStorage removed for compatibility
            loadChatHistory();
            
            // Add file input change listener
            const fileInput = document.getElementById('fileUpload');
            const uploadBtn = document.getElementById('uploadBtn');
            
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload';
                } else {
                    uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload';
                }
            });
        });

        let currentPage = 1;
        let isIncognito = false;
        let mediaRecorder, audioChunks = [];
        let recordingTimeout;

        async function loadChatHistory() {
            const chatLog = document.getElementById('chatLog');
            const loadMoreButton = document.getElementById('loadMoreButton');

            try {
                const response = await fetch(`/get_chat_history?page=${currentPage}&per_page=10`);
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                const data = await response.json();

                if (data.chats && data.chats.length > 0) {
                    data.chats.forEach(chat => {
                        appendChatMessage(chat.prompt, 'user');
                        appendChatMessage(chat.response, 'bot');
                    });
                    chatLog.scrollTop = chatLog.scrollHeight;
                }

                if (data.current_page >= data.total_pages) {
                    loadMoreButton.style.display = 'none';
                } else {
                    loadMoreButton.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }

        function appendChatMessage(message, sender, messageId = null) {
            const chatLog = document.getElementById('chatLog');
            const messageContainer = document.createElement('div');
            messageContainer.className = `message-container ${sender}`;
            messageContainer.dataset.messageId = messageId;

            const messageBubble = document.createElement('div');
            messageBubble.className = `message-bubble ${sender}-message`;

            const messageTextDiv = document.createElement('div');
            messageTextDiv.className = 'message-text';
            messageTextDiv.textContent = message;

            const copyIcon = document.createElement('i');
            copyIcon.className = 'fas fa-copy copy-icon';
            copyIcon.onclick = () => copyText(messageTextDiv);

            messageBubble.appendChild(messageTextDiv);
            messageBubble.appendChild(copyIcon);
            messageContainer.appendChild(messageBubble);
            chatLog.appendChild(messageContainer);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        function copyText(messageElement) {
            const textToCopy = messageElement.textContent || messageElement.innerText;
            navigator.clipboard.writeText(textToCopy).then(() => {
                showNotification('Text copied to clipboard!', 'success');
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${type === 'success' ? 'var(--accent-gradient)' : 'var(--secondary-gradient)'};
                color: white;
                border-radius: 12px;
                font-weight: 600;
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in forwards';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        async function logout() {
            try {
                const response = await fetch('/logout');
                if (response.redirected) {
                    window.location.href = response.url;
                }
            } catch (error) {
                console.error('Error logging out:', error);
            }
        }

        async function loadMoreChatHistory() {
            currentPage++;
            await loadChatHistory();
        }

        function uploadFile() {
            const fileInput = document.getElementById('fileUpload');
            const uploadBtn = document.getElementById('uploadBtn');
            const file = fileInput.files[0];
            if (!file) return;
            
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<span class="spinner"></span> Uploading...';
            
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/upload_file', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload';
                if (data.error) {
                    showNotification('Upload failed: ' + data.error, 'error');
                } else {
                    showNotification('File uploaded successfully!', 'success');
                }
            })
            .catch(error => {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload';
                showNotification('Upload failed.', 'error');
            });
        }

        function showTypingIndicator() {
            const chatLog = document.getElementById('chatLog');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message-container bot typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-bubble bot-message">
                    <div class="message-text">
                        AI is typing
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            `;
            chatLog.appendChild(typingDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function sendMessage() {
            const inputField = document.getElementById('inputField');
            const userInput = inputField.value.trim();
            if (!userInput) return;
            
            inputField.value = '';
            appendChatMessage(userInput, 'user');
            showTypingIndicator();
            
            fetch('/get_response', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_input: userInput, incognito: isIncognito })
            })
            .then(response => response.json())
            .then(data => {
                hideTypingIndicator();
                appendChatMessage(data.response, 'bot');
            })
            .catch(error => {
                hideTypingIndicator();
                appendChatMessage('Failed to get a response. Please try again.', 'bot');
            });
        }

        async function searchChat() {
            const searchInput = document.getElementById('searchInput').value.trim();
            const chatLog = document.getElementById('chatLog');
            chatLog.innerHTML = '';

            try {
                const response = await fetch(`/search_chat_history?query=${encodeURIComponent(searchInput)}`);
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                const data = await response.json();

                if (data.chats && data.chats.length > 0) {
                    data.chats.forEach(chat => {
                        appendChatMessage(chat.prompt, 'user');
                        appendChatMessage(chat.response, 'bot');
                    });
                    chatLog.scrollTop = chatLog.scrollHeight;
                }
            } catch (error) {
                console.error('Error searching chat history:', error);
            }
        }

        function appendRagChatMessage(message, sender) {
            const ragChatLog = document.getElementById('ragChatLog');
            const messageContainer = document.createElement('div');
            messageContainer.className = `message-container ${sender}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `message-bubble ${sender}-message`;

            const messageTextDiv = document.createElement('div');
            messageTextDiv.className = 'message-text';
            messageTextDiv.textContent = message;

            const copyIcon = document.createElement('i');
            copyIcon.className = 'fas fa-copy copy-icon';
            copyIcon.onclick = () => copyText(messageTextDiv);

            messageBubble.appendChild(messageTextDiv);
            messageBubble.appendChild(copyIcon);
            messageContainer.appendChild(messageBubble);
            ragChatLog.appendChild(messageContainer);
            ragChatLog.scrollTop = ragChatLog.scrollHeight;
        }

        function askDocumentQuestion() {
            const input = document.getElementById('docQuestionInput').value.trim();
            if (!input) return;
            
            appendRagChatMessage(input, 'user');
            showTypingIndicator();
            
            fetch('/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: input, incognito: isIncognito })
            })
            .then(response => response.json())
            .then(data => {
                hideTypingIndicator();
                console.log('RAG /ask response:', data);
                appendRagChatMessage(data.answer || data.response || data.error || 'No answer found.', 'bot');
            })
            .catch(error => {
                hideTypingIndicator();
                appendRagChatMessage('Failed to get a response. Please try again.', 'bot');
            });
        }

        function toggleIncognito() {
            const checkbox = document.getElementById('incognitoToggle');
            isIncognito = checkbox.checked;
            console.log('Incognito mode:', isIncognito ? 'ON' : 'OFF');
        }

        function showGroqChat() {
            document.getElementById('groqScreen').style.display = '';
            document.getElementById('ragScreen').style.display = 'none';
            document.getElementById('amritaScreen').style.display = 'none';
            document.getElementById('groqTab').classList.add('active');
            document.getElementById('ragTab').classList.remove('active');
            document.getElementById('amritaTab').classList.remove('active');
        }

        function showRagChat() {
            document.getElementById('groqScreen').style.display = 'none';
            document.getElementById('ragScreen').style.display = '';
            document.getElementById('amritaScreen').style.display = 'none';
            document.getElementById('groqTab').classList.remove('active');
            document.getElementById('ragTab').classList.add('active');
            document.getElementById('amritaTab').classList.remove('active');
            loadRagChatHistory();
        }

        async function loadRagChatHistory() {
            const ragChatLog = document.getElementById('ragChatLog');
            try {
                const response = await fetch('/get_rag_chat_history');
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                const data = await response.json();
                
                if (data.chats && data.chats.length > 0) {
                    data.chats.forEach(chat => {
                        appendRagChatMessage(chat.question, 'user');
                        appendRagChatMessage(chat.answer, 'bot');
                    });
                    ragChatLog.scrollTop = ragChatLog.scrollHeight;
                }
            } catch (error) {
                console.error('Error loading RAG chat history:', error);
            }
        }

        function showAmritaChat() {
            document.getElementById('groqScreen').style.display = 'none';
            document.getElementById('ragScreen').style.display = 'none';
            document.getElementById('amritaScreen').style.display = '';
            document.getElementById('groqTab').classList.remove('active');
            document.getElementById('ragTab').classList.remove('active');
            document.getElementById('amritaTab').classList.add('active');
        }

        function appendAmritaChatMessage(message, sender) {
            const amritaChatLog = document.getElementById('amritaChatLog');
            const messageContainer = document.createElement('div');
            messageContainer.className = `message-container ${sender}`;
            const messageBubble = document.createElement('div');
            messageBubble.className = `message-bubble ${sender}-message`;
            const messageTextDiv = document.createElement('div');
            messageTextDiv.className = 'message-text';
            messageTextDiv.textContent = message;
            const copyIcon = document.createElement('i');
            copyIcon.className = 'fas fa-copy copy-icon';
            copyIcon.onclick = () => copyText(messageTextDiv);
            messageBubble.appendChild(messageTextDiv);
            messageBubble.appendChild(copyIcon);
            messageContainer.appendChild(messageBubble);
            amritaChatLog.appendChild(messageContainer);
            amritaChatLog.scrollTop = amritaChatLog.scrollHeight;
        }

        function askAmritaQuestion() {
            const input = document.getElementById('amritaQuestionInput').value.trim();
            if (!input) return;
            appendAmritaChatMessage(input, 'user');
            showTypingIndicatorAmrita();
            fetch('/amrita_ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: input })
            })
            .then(response => response.json())
            .then(data => {
                hideTypingIndicatorAmrita();
                appendAmritaChatMessage(data.response?.answer || data.answer || data.error || 'No answer found.', 'bot');
            })
            .catch(error => {
                hideTypingIndicatorAmrita();
                appendAmritaChatMessage('Failed to get a response. Please try again.', 'bot');
            });
        }

        function showTypingIndicatorAmrita() {
            const amritaChatLog = document.getElementById('amritaChatLog');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message-container bot typing-indicator';
            typingDiv.id = 'amritaTypingIndicator';
            typingDiv.innerHTML = `
                <div class="message-bubble bot-message">
                    <div class="message-text">
                        AI is typing
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            `;
            amritaChatLog.appendChild(typingDiv);
            amritaChatLog.scrollTop = amritaChatLog.scrollHeight;
        }

        function hideTypingIndicatorAmrita() {
            const typingIndicator = document.getElementById('amritaTypingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function isSupportedBrowser() {
            const ua = navigator.userAgent;
            return /Edg\//.test(ua) || /Chrome\//.test(ua) || /Firefox\//.test(ua) || /Safari\//.test(ua);
        }

        function startTeluguRecording(targetInputId) {
            if (!isSupportedBrowser()) {
                showNotification('Voice input is only supported on Microsoft Edge, Google Chrome, Mozilla Firefox, or Safari. Please use one of these browsers.', 'error');
                return;
            }
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showNotification('Your browser does not support audio recording. Please use Edge, Chrome, Firefox, or Safari, and ensure you are using HTTPS or localhost. You must allow microphone access when prompted.', 'error');
                return;
            }
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => sendTeluguAudio(targetInputId);
                    mediaRecorder.start();
                    showNotification('ðŸŽ™ï¸ Recording... Speak now (5s)', 'info');
                    recordingTimeout = setTimeout(() => mediaRecorder.stop(), 5000); // 5 seconds
                })
                .catch(err => {
                    showNotification('Microphone access denied. Please allow microphone access in your browser settings.', 'error');
                });
        }

        function sendTeluguAudio(targetInputId) {
            clearTimeout(recordingTimeout);
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const formData = new FormData();
            formData.append('audio', audioBlob, 'user_input.wav');
            showNotification('Transcribing audio...', 'info');
            fetch('/transcribe_telugu', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.text) {
                    document.getElementById(targetInputId).value = data.text;
                    showNotification('Transcription complete!', 'success');
                } else if (data.error) {
                    showNotification('Transcription failed: ' + data.error, 'error');
                } else {
                    showNotification('Transcription failed', 'error');
                }
            })
            .catch(() => {
                showNotification('Transcription failed (network or server error)', 'error');
            });
        }
    </script>
</body>
</html>